name: ðŸ”’ Security Audit & Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # ExÃ©cuter quotidiennement Ã  2h du matin
    - cron: '0 2 * * *'

jobs:
  security-audit:
    name: ðŸ” Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” NPM Audit
        run: npm audit --production --audit-level=moderate
        continue-on-error: true

      - name: ðŸ“‹ Generate Security Report
        run: npm run report:audit
        continue-on-error: true

      - name: ðŸ’¾ Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: security-audit.json
          retention-days: 30

  prisma-validation:
    name: âœ… Prisma Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Prisma Validate
        run: npx prisma validate

      - name: ðŸ”§ Prisma Generate
        run: npx prisma generate

  security-tests:
    name: ðŸ§ª Security Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ”§ Prisma Generate
        run: npx prisma generate

      - name: ðŸ§ª Run Security Tests
        run: npm run test:security
        continue-on-error: true

      - name: ðŸ§ª Run Security E2E Tests
        run: npm run test:security:e2e
        continue-on-error: true

      - name: ðŸ’¾ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-results
          path: tests-logs/ci-report/
          retention-days: 30

  type-check:
    name: âœ… TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” TypeScript Check
        run: npm run typecheck

  lint:
    name: ðŸ” ESLint
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Run ESLint
        run: npm run lint

  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [security-audit, prisma-validation, security-tests, type-check, lint]
    if: always()
    
    steps:
      - name: ðŸ’¾ Download Security Report
        uses: actions/download-artifact@v4
        with:
          name: security-audit-report
          continue-on-error: true

      - name: ðŸ“‹ Security Summary
        run: |
          echo "## ðŸ”’ Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security audit completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Prisma validation completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security tests completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… TypeScript check completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Linting completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY

