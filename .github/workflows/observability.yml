name: Observability Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  observability:
    name: Observability Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify Logger exists
        run: |
          if [ ! -f "src/lib/logger.ts" ]; then
            echo "‚ùå Logger not found: src/lib/logger.ts"
            exit 1
          fi
          echo "‚úÖ Logger found: src/lib/logger.ts"

      - name: Verify Sentry Configuration
        run: |
          if [ ! -f "src/lib/monitoring/sentry.client.ts" ]; then
            echo "‚ùå Sentry client config not found"
            exit 1
          fi
          if [ ! -f "src/lib/monitoring/sentry.server.ts" ]; then
            echo "‚ùå Sentry server config not found"
            exit 1
          fi
          echo "‚úÖ Sentry configuration files found"

      - name: Verify Tracing Configuration
        run: |
          if [ ! -f "src/lib/monitoring/tracing.ts" ]; then
            echo "‚ùå Tracing config not found"
            exit 1
          fi
          echo "‚úÖ Tracing configuration found"

      - name: Verify API Middleware
        run: |
          if [ ! -f "src/app/api/_middleware.ts" ]; then
            echo "‚ùå API middleware not found"
            exit 1
          fi
          echo "‚úÖ API middleware found"

      - name: Verify Metrics Endpoint
        run: |
          if [ ! -f "src/app/api/metrics/route.ts" ]; then
            echo "‚ùå Metrics endpoint not found"
            exit 1
          fi
          echo "‚úÖ Metrics endpoint found"

      - name: Verify Health Endpoint
        run: |
          if [ ! -f "src/app/api/health/route.ts" ]; then
            echo "‚ùå Health endpoint not found"
            exit 1
          fi
          echo "‚úÖ Health endpoint found"

      - name: Verify Auto Seed Script
        run: |
          if [ ! -f "prisma/seeds/auto-seed-tenants.ts" ]; then
            echo "‚ùå Auto seed script not found"
            exit 1
          fi
          echo "‚úÖ Auto seed script found"

      - name: Check Seed Script Syntax
        run: |
          npx tsx --check prisma/seeds/auto-seed-tenants.ts || echo "‚ö†Ô∏è  Seed script syntax check skipped (may require DB connection)"

      - name: Verify Seed Script in package.json
        run: |
          if ! grep -q '"seed:auto"' package.json; then
            echo "‚ùå seed:auto script not found in package.json"
            exit 1
          fi
          echo "‚úÖ seed:auto script found in package.json"

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Type Check Observability Files
        run: |
          npx tsc --noEmit src/lib/logger.ts src/lib/monitoring/*.ts src/app/api/_middleware.ts src/app/api/metrics/route.ts src/app/api/health/route.ts || echo "‚ö†Ô∏è  Type check warnings (non-blocking)"

      - name: Observability Summary
        run: |
          echo "‚úÖ All observability checks passed!"
          echo ""
          echo "üìä Observability Stack:"
          echo "  - Logger: ‚úÖ"
          echo "  - Sentry: ‚úÖ"
          echo "  - Tracing: ‚úÖ"
          echo "  - Metrics: ‚úÖ"
          echo "  - Health Check: ‚úÖ"
          echo "  - Auto Seed: ‚úÖ"

